<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>OpenSmartNode</title>
	<style>
table, th, td {border: 1px solid;}
th, td {padding-left: 5px; padding-right: 5px;}
input[type=number] {width: 80px;}
input[type=text],input[type=password] {width: 125px;}
h3 {margin-bottom:10px;}
input {font-size:15px;}
.bb { font-weight: bold; }
.ptr {cursor: pointer;}
	</style>
</head>

<body>
	<h2>OpenSmartNode (File Transfer Utility)
		<span id="svr_reply" style="color:red"></span>
	</h2>
	<h3>Click the file to download, drag file to move, drop in a file to upload.</h3>
	<table id="rc-table">
		<tr>
			<th>Absolute Path</th>
			<th>File Size</th>
			<th>Actions</th>
		</tr>
	</table>
	<p>Drop onto a folder to upload the file to that folder; drop onto a file to overwrite the content of that file.</p>

<script>
	var xmlHttp = new XMLHttpRequest();
	function getById(id_str) { return document.getElementById(id_str); }
	function GET(url, method = 'GET', data = null) {
		xmlHttp.open(method, url, false);
		xmlHttp.send(data);
		return xmlHttp.responseText;
	}
	var tb = getById('rc-table');
	var rid = 0;
	var drag_rid;
	function goto(url) { location.href = url; }
	function save() {
		var N = tb.rows.length - 2;
		var ret = '';
		for (var n = 1; n <= N; ++n)
			ret += [1, 2, 3].map(x => tb.rows[n].children[x].textContent).join('\t') + '\n';
		alert(GET('/rc_save', 'POST', ret));
	}
	function load() {
		try {
			var txt = GET('/list_files').trim();
			if(!txt) return;
			var lines = txt.split('\n');
			while (tb.rows.length > 1) tb.deleteRow(1);
			rid = 1;
			for (var line of lines){
				var row = add_new_row();
				[row.children[0].textContent, row.children[1].textContent] = line.split('\t');
			}
		} catch (err) {
			alert(err);
		}
	}
	function download(rid){
		try {
			var elem = getById('R'+rid);
			window.location.href = `/get_file?${elem.children[0].textContent}`;
		} catch (err) {
			alert(err);
		}
	}
	function deleteFile(rid) {
		try {
			var elem = getById('R'+rid);
			var txt = GET(`/delete_files?${elem.children[0].textContent}`).trim();
			if(txt=='OK') elem.remove();
			else alert(txt);
		} catch (err) {
			alert(err);
		}
	}
	function preventDefaults(e){e.preventDefault();}
	function ondrop(e){
		e.stopPropagation();
		e.preventDefault();
		alert(e.dataTransfer.files[0]);
	}
	function add_new_row() {
		var row = tb.insertRow(tb.rows.length);
		row.setAttribute('id', 'R'+rid);
		row.innerHTML = `<td class="ptr" draggable=true></td> <td></td><td style="text-align:center">
			<input type='button' onclick='download(${rid})' value='Download' title="Download this file/folder">
			<input type='button' onclick='deleteFile(${rid})' value='Delete' title="Delete this file/folder"></td>`;
		rid++;
		var obj = row.children[0];
		['dragenter', 'dragstart', 'dragend', 'dragleave', 'dragover', 'drag', 'drop'].forEach(e => {obj.addEventListener(e, preventDefaults, false)});
		obj.addEventListener("drop", ondrop, false);
		return row;
	}
	window.onload = () => { load(); }
</script>
</body>

</html>